<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>mysql优化学习on DUPLICATE key Update</title>
    <url>/2019/12/31/mysql%E4%BC%98%E5%8C%96%E5%AD%A6%E4%B9%A0on%20DUPLICATE%20key%20Update/</url>
    <content><![CDATA[<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>有张表，里面的记录不能存在重复记录，记录存在就更新，如果不存在就插入，分布式并发场景下会存在以下问题：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> Duplicate entry '1203923435854168066-139-68' for key 'PRIMARY'</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>解决方案</strong></li>
<li><input checked="" disabled="" type="checkbox"> DUPLICATE key Update（本文重点）</li>
<li><input disabled="" type="checkbox"> 分布式锁<a id="more"></a>
</li>
</ul>
<hr>
<ul>
<li><strong>传统做法</strong></li>
</ul>
<p>两条sql语句，对于大并发来说，存在性能问题。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入或更新数据</span></span><br><span class="line"><span class="comment"> * 此方法不会关闭Connection</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> conn   数据库连接</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> record 记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keys   需要检查唯一性的字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 插入行数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException SQL执行异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertOrUpdate</span><span class="params">(Connection conn, Entity record, String... keys)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> Entity where = record.filter(keys);</span><br><span class="line">	<span class="keyword">if</span> (MapUtil.isNotEmpty(where) &amp;&amp; count(conn, where) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> update(conn, record, where);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> insert(conn, record);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="忧化方法"><a href="#忧化方法" class="headerlink" title="忧化方法"></a>忧化方法</h2><p>创建表，注意要有一个唯一索引 new_code_index， 插入或者更新时，以此为标准</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`a`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`b`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`c`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`new_code_index`</span> (<span class="string">`c`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="sql语句实例"><a href="#sql语句实例" class="headerlink" title="sql语句实例"></a>sql语句实例</h3><h4 id="第一次"><a href="#第一次" class="headerlink" title="第一次"></a>第一次</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> ( a, b, c, update_time, create_time ) <span class="keyword">VALUES</span> ( <span class="string">'aaaa'</span>, <span class="string">'bbb'</span>, <span class="keyword">MD5</span>(<span class="keyword">CONCAT</span>(<span class="string">'qwewq'</span>, <span class="string">'qweqw'</span>)), <span class="keyword">NOW</span>(), <span class="keyword">NOW</span>() ) </span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> update_time = <span class="keyword">now</span>(), create_time = <span class="keyword">now</span>();</span><br><span class="line"></span><br><span class="line">受影响的行: 1</span><br><span class="line">时间: 0.005s</span><br></pre></td></tr></table></figure>



<h4 id="第二次"><a href="#第二次" class="headerlink" title="第二次"></a>第二次</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> ( a, b, c, update_time, create_time ) <span class="keyword">VALUES</span> ( <span class="string">'aaaa'</span>, <span class="string">'bbb'</span>, <span class="keyword">MD5</span>(<span class="keyword">CONCAT</span>(<span class="string">'qwewq'</span>, <span class="string">'qweqw'</span>)), <span class="keyword">NOW</span>(), <span class="keyword">NOW</span>() ) </span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> update_time = <span class="keyword">now</span>(), create_time = <span class="keyword">now</span>();</span><br><span class="line"></span><br><span class="line">受影响的行: 2</span><br><span class="line">时间: 0.005s</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2017/05/26/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
      <categories>
        <category>flink</category>
      </categories>
      <tags>
        <tag>nginx</tag>
        <tag>MQ</tag>
        <tag>Neo4J</tag>
      </tags>
  </entry>
  <entry>
    <title>Changelog</title>
    <url>/2017/05/26/Changelog/</url>
    <content><![CDATA[<h2 id="4-5-4"><a href="#4-5-4" class="headerlink" title="4.5.4"></a>4.5.4</h2><h3 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h3><ul>
<li>【core】     NetUtil增加getUsableLocalPort方法，并迁移至cn.hutool.core.net包</li>
<li>【core】     FileUtil增加isSub方法（pr#39@Gitee）<a id="more"></a></li>
<li>【core】     增加VoidFunc</li>
<li>【extra】     mail适配mail.setting和config/mail.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【corn】     cron适配cron.setting和config/cron.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【poi】       ExcelWriter增加autoSizeColumnAll方法，ExcelBase增加getColumnCount、getRowCount方法（感谢@@【长沙】M）</li>
<li>【http】      添加SoapClient，删除SoapRequest</li>
</ul>
<h3 id="Bug修复"><a href="#Bug修复" class="headerlink" title="Bug修复"></a>Bug修复</h3><ul>
<li>【db】        修复Session中事务问题（issue#IUQMN@Gitee）</li>
<li>【db】        修复Db中关闭逻辑错误导致的事务问题（感谢@【宁波】mojie126）</li>
<li>【http】      修复form方法使用Resource可能导致的空指针问题</li>
<li>【crypto】   修复SM2Engine逻辑错误（感谢bcgit/bc-java）</li>
</ul>
<hr>
<h2 id="4-5-4-1"><a href="#4-5-4-1" class="headerlink" title="4.5.4"></a>4.5.4</h2><h3 id="新特性-1"><a href="#新特性-1" class="headerlink" title="新特性"></a>新特性</h3><ul>
<li>【core】     NetUtil增加getUsableLocalPort方法，并迁移至cn.hutool.core.net包</li>
<li>【core】     FileUtil增加isSub方法（pr#39@Gitee）</li>
<li>【core】     增加VoidFunc</li>
<li>【extra】     mail适配mail.setting和config/mail.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【corn】     cron适配cron.setting和config/cron.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【poi】       ExcelWriter增加autoSizeColumnAll方法，ExcelBase增加getColumnCount、getRowCount方法（感谢@@【长沙】M）</li>
<li>【http】      添加SoapClient，删除SoapRequest</li>
</ul>
<h3 id="Bug修复-1"><a href="#Bug修复-1" class="headerlink" title="Bug修复"></a>Bug修复</h3><ul>
<li>【db】        修复Session中事务问题（issue#IUQMN@Gitee）</li>
<li>【db】        修复Db中关闭逻辑错误导致的事务问题（感谢@【宁波】mojie126）</li>
<li>【http】      修复form方法使用Resource可能导致的空指针问题</li>
<li>【crypto】   修复SM2Engine逻辑错误（感谢bcgit/bc-java）</li>
</ul>
<hr>
<h2 id="4-5-3"><a href="#4-5-3" class="headerlink" title="4.5.3"></a>4.5.3</h2><h3 id="新特性-2"><a href="#新特性-2" class="headerlink" title="新特性"></a>新特性</h3><ul>
<li>【core】       Simhash添加读写锁（issue#IUF9O@Gitee）</li>
<li>【core】       Img增加round方法，圆角给定图片</li>
<li>【extra】      二维码中的图片做圆角处理</li>
<li>【core】       CsvData实现Iterable接口</li>
<li>【extra】      Ftp增加重连方法（pr#38@Gitee）</li>
<li>【extra】      Velocity升级至2.x，不再兼容1.7</li>
</ul>
<h3 id="Bug修复-2"><a href="#Bug修复-2" class="headerlink" title="Bug修复"></a>Bug修复</h3><ul>
<li>【core】       修复ReflectUtil新建Map对象错误问题（issue#IUF9O@Gitee）</li>
<li>【core】       修复ImgUtil字体为null导致的空指针问题（issue#IUF3X@Gitee）</li>
<li>【extra】      修复Ftp中文件上传mkdirs方法创建多余文件夹的问题（issue#ITAYV@Gitee）</li>
<li>【extra】      修复Ftp中文件上传mkdirs方法创建多余文件夹的问题（issue#ITAYV@Gitee）</li>
</ul>
<hr>
]]></content>
      <categories>
        <category>spark</category>
      </categories>
      <tags>
        <tag>hive</tag>
        <tag>hbase</tag>
        <tag>kafka</tag>
      </tags>
  </entry>
</search>
