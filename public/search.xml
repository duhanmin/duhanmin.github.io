<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>通用日志收集SDK</title>
    <url>/2020/04/01/%E9%80%9A%E7%94%A8%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86SDK/</url>
    <content><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>该项目可用于java、spark和hadoop项目的运行日志转发到kafka</p>
<p>工程中的日志通过该SDK收集发送到kafka，通过logstash收集到ES，通过kibana建立项目日志索引区分查看</p>
<h2 id="操作方法"><a href="#操作方法" class="headerlink" title="操作方法"></a>操作方法</h2><h3 id="Spark-on-Yarn-日志接入ES"><a href="#Spark-on-Yarn-日志接入ES" class="headerlink" title="Spark on Yarn 日志接入ES"></a>Spark on Yarn 日志接入ES</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">--jars  libs/kafka-clients-1.0.1.3.0.0.0-1634.jar,  \</span><br><span class="line">--files spark-log4j.properties,  \</span><br><span class="line">--conf spark.driver.extraJavaOptions="-Dlog4j.configuration=spark-log4j.properties" \</span><br><span class="line">--conf spark.executor.extraJavaOptions="-Dlog4j.configuration=spark-log4j.properties" \</span><br></pre></td></tr></table></figure>

<h3 id="Java、Spring、Spark、Flink接入日志方式类似"><a href="#Java、Spring、Spark、Flink接入日志方式类似" class="headerlink" title="Java、Spring、Spark、Flink接入日志方式类似"></a>Java、Spring、Spark、Flink接入日志方式类似</h3><ul>
<li>详见Spark和Flink官网</li>
<li>接入日志方式类似，详见下文中logback和log4j</li>
</ul>
<h3 id="logback方式配置模板"><a href="#logback方式配置模板" class="headerlink" title="logback方式配置模板"></a>logback方式配置模板</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">scan</span>=<span class="string">"true"</span> <span class="attr">scanPeriod</span>=<span class="string">"3 seconds"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--设置日志输出为控制台--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"STDOUT"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.ConsoleAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%-5level] [%logger&#123;32&#125;] %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"KAFKA"</span> <span class="attr">class</span>=<span class="string">"com.router.log.kafka.log4jappender.KafkaLogbackAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.filter.ThresholdFilter"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>WARN<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">syncSend</span>&gt;</span>false<span class="tag">&lt;/<span class="name">syncSend</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">brokerList</span>&gt;</span>ip:port<span class="tag">&lt;/<span class="name">brokerList</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appName</span>&gt;</span>hotwheels-api<span class="tag">&lt;/<span class="name">appName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">topic</span>&gt;</span>HOTWHEELS-REALTIME_LOG<span class="tag">&lt;/<span class="name">topic</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--设置日志输出为文件--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">"FILE"</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.RollingFileAppender"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">File</span>&gt;</span>logFile.log<span class="tag">&lt;/<span class="name">File</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span>  <span class="attr">class</span>=<span class="string">"ch.qos.logback.core.rolling.TimeBasedRollingPolicy"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">FileNamePattern</span>&gt;</span>logFile.%d&#123;yyyy-MM-dd_HH-mm&#125;.log.zip<span class="tag">&lt;/<span class="name">FileNamePattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">"ch.qos.logback.classic.PatternLayout"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Pattern</span>&gt;</span>%d&#123;HH:mm:ss,SSS&#125; [%thread] %-5level %logger&#123;32&#125; - %msg%n<span class="tag">&lt;/<span class="name">Pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">level</span> <span class="attr">value</span>=<span class="string">"info"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"STDOUT"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"FILE"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">"KAFKA"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>

<h3 id="log4j方式配置模板"><a href="#log4j方式配置模板" class="headerlink" title="log4j方式配置模板"></a>log4j方式配置模板</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">log4j.rootLogger=INFO,console,KAFKA</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># appender KAFKA</span></span></span><br><span class="line">log4j.appender.KAFKA=com.router.log.kafka.log4jappender.KafkaLog4jAppender</span><br><span class="line">log4j.appender.KAFKA.topic=topic</span><br><span class="line">log4j.appender.KAFKA.appName=name</span><br><span class="line">log4j.appender.KAFKA.brokerList=ip:port</span><br><span class="line">log4j.appender.KAFKA.compressionType=none</span><br><span class="line">log4j.appender.KAFKA.syncSend=true</span><br><span class="line">log4j.appender.KAFKA.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.KAFKA.Threshold=WARN</span><br><span class="line">log4j.appender.KAFKA.layout.ConversionPattern=%d (%t) [%p - %l] %m%n</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># appender console</span></span></span><br><span class="line">log4j.appender.console=org.apache.log4j.ConsoleAppender</span><br><span class="line">log4j.appender.console.target=System.out</span><br><span class="line">log4j.appender.console.layout=org.apache.log4j.PatternLayout</span><br><span class="line">log4j.appender.console.layout.ConversionPattern=%d (%t) [%p - %l] %m%n</span><br></pre></td></tr></table></figure>

<h3 id="Maven引入Jar包"><a href="#Maven引入Jar包" class="headerlink" title="Maven引入Jar包"></a>Maven引入Jar包</h3><p>下载源</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>maven-repo-master<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://raw.github.com/duhanmin/log-router/master/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">updatePolicy</span>&gt;</span>always<span class="tag">&lt;/<span class="name">updatePolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>包</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.router<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>log-router<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>日志样例</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"fqnOfCategoryClass"</span>: <span class="string">"org.apache.commons.logging.impl.SLF4JLocationAwareLog"</span>,</span><br><span class="line">    <span class="attr">"eventId"</span>: <span class="string">"07d643ef-d86a-4c37-9612-28b2b81936e3"</span>,</span><br><span class="line">    <span class="attr">"address"</span>: <span class="string">"192.168.2.155"</span>,</span><br><span class="line">    <span class="attr">"level"</span>: <span class="string">"ERROR"</span>,</span><br><span class="line">    <span class="attr">"eventChannel"</span>: <span class="string">"topic"</span>,</span><br><span class="line">    <span class="attr">"message"</span>: <span class="string">"错误来了"</span>,</span><br><span class="line">    <span class="attr">"categoryName"</span>: <span class="string">"2019-06-03 16:02:47,327 (Executor task launch worker for task 3) [ERROR - test.rocketmq.rocketmqT$1.process(rocketmqT.java:56)] 错误来了"</span>,</span><br><span class="line">    <span class="attr">"threadName"</span>: <span class="string">"Executor task launch worker for task 3"</span>,</span><br><span class="line">    <span class="attr">"timeStamp"</span>: <span class="string">"1559548967327"</span>,</span><br><span class="line">    <span class="attr">"throwableInfo"</span>: <span class="string">"java.lang.ArithmeticException: / by zero   at test.rocketmq.rocketmqT$1.process(rocketmqT.java:54)   at test.rocketmq.rocketmqT$1.process(rocketmqT.java:49)   at org.apache.spark.sql.execution.streaming.ForeachSink$$anonfun$addBatch$1.apply(ForeachSink.scala:53)   at org.apache.spark.sql.execution.streaming.ForeachSink$$anonfun$addBatch$1.apply(ForeachSink.scala:49)   at org.apache.spark.rdd.RDD$$anonfun$foreachPartition$1$$anonfun$apply$29.apply(RDD.scala:935)   at org.apache.spark.rdd.RDD$$anonfun$foreachPartition$1$$anonfun$apply$29.apply(RDD.scala:935)   at org.apache.spark.SparkContext$$anonfun$runJob$5.apply(SparkContext.scala:2074)   at org.apache.spark.SparkContext$$anonfun$runJob$5.apply(SparkContext.scala:2074)   at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:87)   at org.apache.spark.scheduler.Task.run(Task.scala:109)   at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:345)   at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)   at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)   at java.lang.Thread.run(Thread.java:745)  "</span>,</span><br><span class="line">    <span class="attr">"eventTime"</span>: <span class="number">1559548967341</span>,</span><br><span class="line">    <span class="attr">"host_name"</span>: <span class="string">"DESKTOP-V0FGT1M"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>logstash配置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        bootstrap_servers =&gt; ["ip1:port,ip2:port"]</span><br><span class="line">        group_id =&gt; "es-transfer"</span><br><span class="line">        topics =&gt; ["HOTWHEELS-REALTIME_LOG"]</span><br><span class="line">        consumer_threads =&gt; 5</span><br><span class="line">        decorate_events =&gt; true</span><br><span class="line">        codec =&gt; "json"</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt; ["ip1:port","ip2:port"]</span><br><span class="line">        codec =&gt; "json"</span><br><span class="line">        index =&gt; "%&#123;eventChannel&#125;"</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>日志</category>
      </categories>
      <tags>
        <tag>kafka</tag>
        <tag>flink</tag>
        <tag>spark</tag>
        <tag>ES</tag>
        <tag>kibana</tag>
        <tag>spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Centos7使用CDH6.3.X安装大数据集群</title>
    <url>/2020/03/25/Centos7%E4%BD%BF%E7%94%A8CDH6.3.X%E5%AE%89%E8%A3%85%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%9B%86%E7%BE%A4/</url>
    <content><![CDATA[<h2 id="修改网络和主机名"><a href="#修改网络和主机名" class="headerlink" title="修改网络和主机名"></a>修改网络和主机名</h2><p>cdh6-master</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@cdh6-master ~]# hostnamectl set-hostname cdh6-master</span><br><span class="line"></span><br><span class="line">[root@cdh6-master ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=bdf6fb11-50f4-403a-8ba6-b9dca61a591e</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">IPADDR=192.168.200.101</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.200.2</span><br><span class="line">DNS1=8.8.8.8</span><br></pre></td></tr></table></figure>

<a id="more"></a>

<p>cdh6-slave1</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cdh6-slave1[root@cdh6-slave1 ~]# hostnamectl set-hostname cdh6-slave1</span><br><span class="line"></span><br><span class="line">[root@cdh6-slave1 ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=e2b4e53e-5a4d-4b20-b6ff-39a67539214a</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">IPADDR=192.168.200.102</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.200.2</span><br><span class="line">DNS1=8.8.8.8</span><br></pre></td></tr></table></figure>

<p>cdh6-slave2</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@cdh6-slave2 ~]# hostnamectl set-hostname cdh6-slave2</span><br><span class="line"></span><br><span class="line">[root@cdh6-slave2 ~]# vi /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=static</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=ens33</span><br><span class="line">UUID=a15136a1-c83b-4750-9ff3-2ca779e39818</span><br><span class="line">DEVICE=ens33</span><br><span class="line">ONBOOT=yes</span><br><span class="line"></span><br><span class="line">IPADDR=192.168.200.103</span><br><span class="line">NETMASK=255.255.255.0</span><br><span class="line">GATEWAY=192.168.200.2</span><br><span class="line">DNS1=8.8.8.8</span><br></pre></td></tr></table></figure>

<h2 id="关闭防火墙和SELinux"><a href="#关闭防火墙和SELinux" class="headerlink" title="关闭防火墙和SELinux"></a>关闭防火墙和SELinux</h2><p>host</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/hosts：</span><br><span class="line"></span><br><span class="line">192.168.200.101        cdh6-master</span><br><span class="line">192.168.200.102        cdh6-slave1</span><br><span class="line">192.168.200.103        cdh6-slave2</span><br></pre></td></tr></table></figure>
<p>防火墙</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 关闭防火墙</span></span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 禁止防火墙开机自启</span></span></span><br><span class="line">systemctl disable firewalld</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 临时生效</span></span></span><br><span class="line">setenforce 0</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 永久生效</span></span></span><br><span class="line">修改 /etc/selinux/config 下的 SELINUX=disabled</span><br></pre></td></tr></table></figure>

<h2 id="SSH免密登陆"><a href="#SSH免密登陆" class="headerlink" title="SSH免密登陆"></a>SSH免密登陆</h2><p>在cdh6-master节点(只需要主节点能免密登陆其它节点以及自己就可以了)：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 输入之后一直回车</span></span></span><br><span class="line">ssh-keygen    </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 赋值秘钥到其它节点包括自己</span></span></span><br><span class="line">ssh-copy-id   cdh6-master</span><br><span class="line">ssh-copy-id   cdh6-slave1</span><br><span class="line">ssh-copy-id   cdh6-slave2</span><br></pre></td></tr></table></figure>

<p>注意事项：如果出现 ssh-copy-id: command not found 需要执行该命令（yum -y install openssh-clients）</p>
<h2 id="集群时间同步"><a href="#集群时间同步" class="headerlink" title="集群时间同步"></a>集群时间同步</h2><h3 id="所有节点"><a href="#所有节点" class="headerlink" title="所有节点"></a>所有节点</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#全部节点安装ntp</span></span></span><br><span class="line">rpm -qa |grep ntpd</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##没有安装ntp,则需要安装此服务</span></span></span><br><span class="line">yum install -y ntp</span><br></pre></td></tr></table></figure>

<h3 id="cdh6-master"><a href="#cdh6-master" class="headerlink" title="cdh6-master"></a>cdh6-master</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">vi /etc/ntp.conf</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##去掉这个注释，将地址改成网段地址</span></span></span><br><span class="line">restrict 192.168.200.2 mask 255.255.255.0 nomodify notrap</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##注释掉这几个</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 0.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 1.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 2.centos.pool.ntp.org iburst</span></span><br><span class="line"><span class="meta">#</span><span class="bash">server 3.centos.pool.ntp.org iburst</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##添加一下内容</span></span></span><br><span class="line">server 127.127.1.0</span><br><span class="line">fudge  127.127.1.0  stratum  10</span><br><span class="line"></span><br><span class="line">vi /etc/sysconfig/ntpd</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##加入下面一句话，用于配置boot时间和系统时间同步</span></span></span><br><span class="line">SYNC_HWCLOCK=yes</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##可选，选择上海时区</span></span></span><br><span class="line">ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br></pre></td></tr></table></figure>


<h3 id="cdh6-slave1和cdh6-slave2"><a href="#cdh6-slave1和cdh6-slave2" class="headerlink" title="cdh6-slave1和cdh6-slave2"></a>cdh6-slave1和cdh6-slave2</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 输入 crontab -e 命令进入编辑状态，然后输入一下内容（该任务保存在目录/var/spool/cron　下，必须用root用户才能看到  ）</span></span></span><br><span class="line"></span><br><span class="line">* * * * * /usr/sbin/ntpdate        cdh6-master</span><br></pre></td></tr></table></figure>


<h3 id="启动所有节点的ntp"><a href="#启动所有节点的ntp" class="headerlink" title="启动所有节点的ntp"></a>启动所有节点的ntp</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">service ntpd start</span><br><span class="line"></span><br><span class="line">chkconfig ntpd on</span><br></pre></td></tr></table></figure>

<h2 id="安装repo、GPG-key、jdk"><a href="#安装repo、GPG-key、jdk" class="headerlink" title="安装repo、GPG key、jdk"></a>安装repo、GPG key、jdk</h2><p>所有节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 安装repo，如果没有wget就yum install -y wget</span></span></span><br><span class="line">wget https://archive.cloudera.com/cm6/6.3.0/redhat7/yum/cloudera-manager.repo -P /etc/yum.repos.d/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 导入GPG key</span></span></span><br><span class="line">rpm --import https://archive.cloudera.com/cm6/6.3.0/redhat7/yum/RPM-GPG-KEY-cloudera</span><br></pre></td></tr></table></figure>

<p>jdk</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 安装jdk</span></span></span><br><span class="line">yum install -y oracle-j2sdk1.8</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 配置java环境变量</span></span></span><br><span class="line">vi /etc/profile</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 最后面加上</span></span></span><br><span class="line">export JAVA_HOME=/usr/java/jdk1.8.0_141-cloudera</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># 生效环境变量</span></span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<h2 id="docker安装mysql"><a href="#docker安装mysql" class="headerlink" title="docker安装mysql"></a>docker安装mysql</h2><p>略</p>
<h2 id="安装MySQL-JDBC-Driver"><a href="#安装MySQL-JDBC-Driver" class="headerlink" title="安装MySQL JDBC Driver"></a>安装MySQL JDBC Driver</h2><p>所有节点</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">wget https:&#x2F;&#x2F;dev.mysql.com&#x2F;get&#x2F;Downloads&#x2F;Connector-J&#x2F;mysql-connector-java-5.1.46.tar.gz</span><br><span class="line"></span><br><span class="line">tar -zxvf mysql-connector-java-5.1.46.tar.gz</span><br><span class="line"></span><br><span class="line">mkdir -p &#x2F;usr&#x2F;share&#x2F;java&#x2F;</span><br><span class="line"></span><br><span class="line">cd mysql-connector-java-5.1.46</span><br><span class="line"></span><br><span class="line">cp mysql-connector-java-5.1.46-bin.jar &#x2F;usr&#x2F;share&#x2F;java&#x2F;mysql-connector-java.jar</span><br></pre></td></tr></table></figure>


<p>注意：一定要将mysql-connector-java-5.1.46-bin.jar改名为mysql-connector-java.jar，不然初始化cm的时候无法识别。</p>
<h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><p>在安装MySQL的节点，需要建的库有scm、amon、rman、hue、metastore、sentry、nav、navms、oozie</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> scm <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> amon <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> rman <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> hue <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> metastore <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> sentry <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> <span class="keyword">nav</span> <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> navms <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> oozie <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">DATABASE</span> hive <span class="keyword">DEFAULT</span> <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">DEFAULT</span> <span class="keyword">COLLATE</span> utf8_general_ci;</span><br></pre></td></tr></table></figure>


<p>开放远程权限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> use mysql;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> grant all privileges on *.* to <span class="string">'root'</span>@<span class="string">'%'</span> identified by <span class="string">'123456'</span> with grant option;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> grant all privileges on *.* to <span class="string">'scm'</span>@<span class="string">'master.cdh6'</span> identified by <span class="string">'123456'</span> with grant option;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br></pre></td></tr></table></figure>

<h2 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h2><p>我这里MySQL安装在cdh6-slave1节点，cm-server安装在cdh6-master节点</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/opt/cloudera/cm/schema/scm_prepare_database.sh mysql -h cdh6-slave1 --scm-host cdh6-master scm scm</span><br></pre></td></tr></table></figure>

<p>注意事项，如果MySQL和cm-server在一台服务器上：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">/opt/cloudera/cm/schema/scm_prepare_database.sh mysql scm scm</span><br></pre></td></tr></table></figure>

<h2 id="离线安装cdh"><a href="#离线安装cdh" class="headerlink" title="离线安装cdh"></a>离线安装cdh</h2><h3 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h3><h4 id="CM"><a href="#CM" class="headerlink" title="CM"></a>CM</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cloudera-manager-server-db-2-6.3.1-1466458.el7.x86_64.rpm</span><br><span class="line">cloudera-manager-server-6.3.1-1466458.el7.x86_64.rpm</span><br><span class="line">cloudera-manager-daemons-6.3.1-1466458.el7.x86_64.rpm</span><br><span class="line">cloudera-manager-agent-6.3.1-1466458.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<h4 id="CDH"><a href="#CDH" class="headerlink" title="CDH"></a>CDH</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">CDH-6.3.2-1.cdh6.3.2.p0.1605554-el7.parcel</span><br><span class="line">CDH-6.3.2-1.cdh6.3.2.p0.1605554-el7.parcel.sha1</span><br><span class="line">CDH-6.3.2-1.cdh6.3.2.p0.1605554-el7.parcel.sha256</span><br></pre></td></tr></table></figure>
<p><strong>注意：</strong><br>CDH-6.3.0-1.cdh6.3.0.p0.1279813-el7.parcel.sha256重命名为CDH-6.3.0-1.cdh6.3.0.p0.1279813-el7.parcel.sha，这点必须注意否则，系统会重新下载。<br>然后，CDH-6.3.0-1.cdh6.3.0.p0.1279813-el7.parcel.sha中的秘钥修改为对应版本的秘钥。</p>
<h3 id="解压CM安装包"><a href="#解压CM安装包" class="headerlink" title="解压CM安装包"></a>解压CM安装包</h3><p>环境依赖安装：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install -y perl</span><br><span class="line"></span><br><span class="line">yum install -y bind-utils psmisc libxslt cyrus-sasl-plain cyrus-sasl-gssapi fuse portmap fuse-libs httpd mod_ssl openssl-devel python-psycopg2 MySQL-python &#x2F;lib&#x2F;lsb&#x2F;init-functions libpq.so.5</span><br></pre></td></tr></table></figure>


<p>所有节点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rpm -ivh cloudera-manager-daemons-6.3.0-1281944.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh cloudera-manager-agent-6.3.0-1281944.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>仅仅在master节点：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rpm -ivh cloudera-manager-server-6.3.0-1281944.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>


<p>修改所有节点的CM主机指向</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vi &#x2F;etc&#x2F;cloudera-scm-agent&#x2F;config.ini</span><br><span class="line"># 将server_host修改为CM-Server所在的主机名</span><br><span class="line">server_host&#x3D;cdh6-master</span><br></pre></td></tr></table></figure>
<h3 id="启动cdh6-master节点的cloudera-scm-server"><a href="#启动cdh6-master节点的cloudera-scm-server" class="headerlink" title="启动cdh6-master节点的cloudera-scm-server"></a>启动cdh6-master节点的cloudera-scm-server</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start cloudera-scm-server</span><br><span class="line"></span><br><span class="line">systemctl enable cloudera-scm-server</span><br></pre></td></tr></table></figure>

<p>等待server启动完毕之后，再启动所有节点的cloudera-scm-agent</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">systemctl start cloudera-scm-agent</span><br><span class="line">systemctl enable cloudera-scm-agent</span><br></pre></td></tr></table></figure>

<h3 id="web安装大数据组件"><a href="#web安装大数据组件" class="headerlink" title="web安装大数据组件"></a>web安装大数据组件</h3><p>略</p>
<h2 id="可能会遇到的问题"><a href="#可能会遇到的问题" class="headerlink" title="可能会遇到的问题"></a>可能会遇到的问题</h2><h3 id="虚拟内存设置"><a href="#虚拟内存设置" class="headerlink" title="虚拟内存设置"></a>虚拟内存设置</h3><p>Cloudera 建议将 /proc/sys/vm/swappiness 设置为 0。当前设置为 60。使用 sysctl 命令在运行时更改该设置并编辑 /etc/sysctl.conf 以在重启后保存该设置。您可以继续进行安装，但可能会遇到问题，Cloudera Manager 报告您的主机由于交换运行状况不佳。以下主机受到影响</p>
<ul>
<li><p>临时解决</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo 0 &gt; &#x2F;proc&#x2F;sys&#x2F;vm&#x2F;swappiness</span><br></pre></td></tr></table></figure>
</li>
<li><p>永久解决</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">sysctl -w vm.swappiness&#x3D;0</span><br><span class="line"></span><br><span class="line">echo vm.swappiness &#x3D; 0 &gt;&gt; &#x2F;etc&#x2F;sysctl.conf</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="大内存设置"><a href="#大内存设置" class="headerlink" title="大内存设置"></a>大内存设置</h3><p>大内存页禁用</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">echo never&gt;&#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;defrag</span><br><span class="line"></span><br><span class="line">echo never&gt;&#x2F;sys&#x2F;kernel&#x2F;mm&#x2F;transparent_hugepage&#x2F;enabled</span><br></pre></td></tr></table></figure>

<h3 id="升级软件依赖版本"><a href="#升级软件依赖版本" class="headerlink" title="升级软件依赖版本"></a>升级软件依赖版本</h3><p>Starting with CDH 6, PostgreSQL-backed Hue requires the Psycopg2 version to be at least 2.5.4, see the documentation for more information. This warning can be ignored if hosts will not run CDH 6, or will not run Hue with PostgreSQL. The following hosts have an incompatible Psycopg2 version of ‘2.5.1’</p>
<p>解决方法：可以忽略</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">yum install python-pip</span><br><span class="line"></span><br><span class="line">pip install --upgrade psycopg2</span><br></pre></td></tr></table></figure>

<h3 id="安装Parcel提示主机运行状况不良"><a href="#安装Parcel提示主机运行状况不良" class="headerlink" title="安装Parcel提示主机运行状况不良"></a>安装Parcel提示主机运行状况不良</h3><ul>
<li>解决方法</li>
</ul>
<p>删除agent目录下面的cm_guid文件，并重启失败节点的agent服务恢复。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">find &#x2F; -name cm_guid</span><br><span class="line">&#x2F;var&#x2F;lib&#x2F;cloudera-scm-agent&#x2F;cm_guid</span><br><span class="line"></span><br><span class="line">删除它&#x2F;var&#x2F;lib&#x2F;cloudera-scm-agent&#x2F;cm_guid</span><br><span class="line"></span><br><span class="line">###重启agent</span><br><span class="line">systemctl cloudera-scm-agent restart</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CDH</category>
      </categories>
      <tags>
        <tag>运维</tag>
        <tag>CDH</tag>
      </tags>
  </entry>
  <entry>
    <title>flink on yarn部署</title>
    <url>/2019/12/31/flink%20on%20yarn%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<p>flink on yarn需要的组件与版本如下</p>
<ol>
<li>Zookeeper 3.4.9 用于做Flink的JobManager的HA服务</li>
<li>hadoop 2.7.2 搭建HDFS和Yarn</li>
<li>flink 1.9.1（scala 2.11）</li>
</ol>
<a id="more"></a>

<p>Zookeeper, HDFS 和 Yarn 的组件的安装可以参照网上的教程。</p>
<p>在zookeeper，HDFS 和Yarn的组件的安装好的前提下，在客户机上提交Flink任务，具体流程如下：</p>
<ul>
<li>在启动Yarn-Session 之前， 设置好HADOOP_HOME,YARN_CONF_DIR ， HADOOP_CONF_DIR环境变量中三者的一个。如下所示， 根据具体的hadoop 路径来设置（CDH和HDP不知道的话可以在机器上直接搜索）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ export HADOOP_HOME&#x3D;&#x2F;usr&#x2F;local&#x2F;hadoop-current</span><br></pre></td></tr></table></figure>
<ul>
<li>配置flink 目录下的flink-conf.yaml, 如下所示<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jobmanager.rpc.address:</span> <span class="string">localhost</span></span><br><span class="line"><span class="attr">jobmanager.rpc.port:</span> <span class="number">6123</span></span><br><span class="line"><span class="attr">jobmanager.heap.mb:</span> <span class="number">256</span></span><br><span class="line"><span class="attr">taskmanager.heap.mb:</span> <span class="number">512</span></span><br><span class="line"><span class="attr">taskmanager.numberOfTaskSlots:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">taskmanager.memory.preallocate:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">parallelism.default:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">jobmanager.web.port:</span> <span class="number">8081</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># yarn</span></span><br><span class="line"><span class="attr">yarn.maximum-failed-containers:</span> <span class="number">99999</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#akka config</span></span><br><span class="line"><span class="attr">akka.watch.heartbeat.interval:</span> <span class="number">5</span> <span class="string">s</span></span><br><span class="line"><span class="attr">akka.watch.heartbeat.pause:</span> <span class="number">20</span> <span class="string">s</span></span><br><span class="line"><span class="attr">akka.ask.timeout:</span> <span class="number">60</span> <span class="string">s</span></span><br><span class="line"><span class="attr">akka.framesize:</span> <span class="string">20971520b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#high-avaliability</span></span><br><span class="line"><span class="attr">high-availability:</span> <span class="string">zookeeper</span></span><br><span class="line"><span class="comment">## 根据安装的zookeeper信息填写</span></span><br><span class="line"><span class="attr">high-availability.zookeeper.quorum:</span> <span class="string">****:2181,****:2181,****:2181</span></span><br><span class="line"><span class="attr">high-availability.zookeeper.path.root:</span> <span class="string">/flink</span></span><br><span class="line"><span class="comment">## HA 信息存储到HDFS的目录，根据各自的Hdfs情况修改</span></span><br><span class="line"><span class="attr">high-availability.zookeeper.storageDir:</span> <span class="string">hdfs://hdcluster/flink/recovery/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#checkpoint config</span></span><br><span class="line"><span class="attr">state.backend:</span> <span class="string">rocksdb</span></span><br><span class="line"><span class="comment">## checkpoint到HDFS的目录 根据各自安装的HDFS情况修改</span></span><br><span class="line"><span class="attr">state.backend.fs.checkpointdir:</span> <span class="string">hdfs://hdcluster/flink/checkpoint</span></span><br><span class="line"><span class="comment">## 对外checkpoint到HDFS的目录</span></span><br><span class="line"><span class="attr">state.checkpoints.dir:</span> <span class="string">hdfs://hdcluster/flink/savepoint</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#memory config</span></span><br><span class="line"><span class="attr">env.java.opts:</span> <span class="string">-XX:+UseConcMarkSweepGC</span> <span class="string">-XX:CMSInitiatingOccupancyFraction=75</span> <span class="string">-XX:+UseCMSInitiatingOccupancyOnly</span> <span class="string">-XX:+AlwaysPreTouch</span> <span class="string">-server</span> <span class="string">-XX:+HeapDumpOnOutOfMemoryError</span></span><br><span class="line"><span class="attr">yarn.heap-cutoff-ratio:</span> <span class="number">0.2</span></span><br><span class="line"><span class="attr">taskmanager.memory.off-heap:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></li>
<li>提交Yarn-Session，切换到flink的bin 目录下,提交命令如下<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;yarn-session.sh -n 2 -s 6 -jm 3072 -tm 6144 -nm test -d</span><br></pre></td></tr></table></figure>
启动yarn-session的参数解释如下</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数解释</th>
<th>设置推荐</th>
</tr>
</thead>
<tbody><tr>
<td>-n(–container)</td>
<td>taskmanager的数量</td>
<td></td>
</tr>
<tr>
<td>-s(–slots)</td>
<td>用启动应用所需的slot数量/ -s 的值向上取整，有时可以多一些taskmanager，做冗余 每个taskmanager的slot数量，默认一个slot一个core，默认每个taskmanager的slot的个数为1</td>
<td>6～10</td>
</tr>
<tr>
<td>-jm</td>
<td>jobmanager的内存（单位MB)</td>
<td>3072</td>
</tr>
<tr>
<td>-tm</td>
<td>每个taskmanager的内存（单位MB)</td>
<td>根据core 与内存的比例来设置，-s的值＊ （core与内存的比）来算</td>
</tr>
<tr>
<td>-nm</td>
<td>yarn 的appName(现在yarn的ui上的名字)｜</td>
<td></td>
</tr>
<tr>
<td>-d</td>
<td>后台执行</td>
<td></td>
</tr>
</tbody></table>
<ul>
<li>提交yarn－session 后，可以在yarn的ui上看到一个应用（应用有一个appId）, 切换到flink的bin目录下，提交flink 应用。命令如下<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;flink -run file:&#x2F;&#x2F;&#x2F;home&#x2F;yarn&#x2F;test.jar -a 1 -p 12 -yid appId -nm flink-test -d</span><br></pre></td></tr></table></figure>
启动flink 应用的参数解释如下</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>参数解释</th>
</tr>
</thead>
<tbody><tr>
<td>-j</td>
<td>运行flink 应用的jar所在的目录</td>
</tr>
<tr>
<td>-a</td>
<td>运行flink 应用的主方法的参数</td>
</tr>
<tr>
<td>-p</td>
<td>运行flink应用的并行度</td>
</tr>
<tr>
<td>-c</td>
<td>运行flink应用的主类, 可以通过在打包设置主类</td>
</tr>
<tr>
<td>-nm</td>
<td>flink 应用名字，在flink-ui 上面展示</td>
</tr>
<tr>
<td>-d</td>
<td>后台执行</td>
</tr>
<tr>
<td>–fromsavepoint</td>
<td>flink 应用启动的状态恢复点</td>
</tr>
</tbody></table>
<ul>
<li>启动flink应用成功，即可在yarn ui 点击对应应用的ApplicationMaster链接,既可以查看flink-ui ，并查看flink 应用运行情况。</li>
</ul>
]]></content>
      <categories>
        <category>flink</category>
      </categories>
      <tags>
        <tag>flink</tag>
        <tag>yarn</tag>
      </tags>
  </entry>
  <entry>
    <title>mysql优化on DUPLICATE key Update</title>
    <url>/2019/12/31/mysql%E4%BC%98%E5%8C%96on%20DUPLICATE%20key%20Update/</url>
    <content><![CDATA[<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>有张表，里面的记录不能存在重复记录，记录存在就更新，如果不存在就插入，分布式并发场景下会存在以下问题：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> Duplicate entry '1203923435854168066-139-68' for key 'PRIMARY'</span><br></pre></td></tr></table></figure>

<hr>
<ul>
<li><strong>解决方案</strong></li>
<li><input checked="" disabled="" type="checkbox"> DUPLICATE key Update（本文重点）</li>
<li><input disabled="" type="checkbox"> 分布式锁<a id="more"></a>
</li>
</ul>
<hr>
<ul>
<li><strong>传统做法</strong></li>
</ul>
<p>两条sql语句，对于大并发来说，存在性能问题。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入或更新数据</span></span><br><span class="line"><span class="comment"> * 此方法不会关闭Connection</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> conn   数据库连接</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> record 记录</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> keys   需要检查唯一性的字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 插入行数</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException SQL执行异常</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertOrUpdate</span><span class="params">(Connection conn, Entity record, String... keys)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">final</span> Entity where = record.filter(keys);</span><br><span class="line">	<span class="keyword">if</span> (MapUtil.isNotEmpty(where) &amp;&amp; count(conn, where) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> update(conn, record, where);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> insert(conn, record);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="优化方法"><a href="#优化方法" class="headerlink" title="优化方法"></a>优化方法</h2><p>创建表，注意要有一个唯一索引 new_code_index， 插入或者更新时，以此为标准</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`a`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`b`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`c`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="built_in">CHARACTER</span> <span class="keyword">SET</span> utf8 <span class="keyword">COLLATE</span> utf8_general_ci <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`update_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`create_time`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`new_code_index`</span> (<span class="string">`c`</span>) <span class="keyword">USING</span> BTREE</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="sql语句实例"><a href="#sql语句实例" class="headerlink" title="sql语句实例"></a>sql语句实例</h3><h4 id="第一次"><a href="#第一次" class="headerlink" title="第一次"></a>第一次</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> ( a, b, c, update_time, create_time ) <span class="keyword">VALUES</span> ( <span class="string">'aaaa'</span>, <span class="string">'bbb'</span>, <span class="keyword">MD5</span>(<span class="keyword">CONCAT</span>(<span class="string">'qwewq'</span>, <span class="string">'qweqw'</span>)), <span class="keyword">NOW</span>(), <span class="keyword">NOW</span>() ) </span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> update_time = <span class="keyword">now</span>(), create_time = <span class="keyword">now</span>();</span><br><span class="line"></span><br><span class="line">受影响的行: 1</span><br><span class="line">时间: 0.005s</span><br></pre></td></tr></table></figure>



<h4 id="第二次"><a href="#第二次" class="headerlink" title="第二次"></a>第二次</h4><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">test</span> ( a, b, c, update_time, create_time ) <span class="keyword">VALUES</span> ( <span class="string">'aaaa'</span>, <span class="string">'bbb'</span>, <span class="keyword">MD5</span>(<span class="keyword">CONCAT</span>(<span class="string">'qwewq'</span>, <span class="string">'qweqw'</span>)), <span class="keyword">NOW</span>(), <span class="keyword">NOW</span>() ) </span><br><span class="line"><span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> update_time = <span class="keyword">now</span>(), create_time = <span class="keyword">now</span>();</span><br><span class="line"></span><br><span class="line">受影响的行: 2</span><br><span class="line">时间: 0.005s</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
        <tag>优化</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2017/05/26/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
      <categories>
        <category>flink</category>
      </categories>
      <tags>
        <tag>nginx</tag>
        <tag>MQ</tag>
        <tag>Neo4J</tag>
      </tags>
  </entry>
  <entry>
    <title>Changelog</title>
    <url>/2017/05/26/Changelog/</url>
    <content><![CDATA[<h2 id="4-5-4"><a href="#4-5-4" class="headerlink" title="4.5.4"></a>4.5.4</h2><h3 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a>新特性</h3><ul>
<li>【core】     NetUtil增加getUsableLocalPort方法，并迁移至cn.hutool.core.net包</li>
<li>【core】     FileUtil增加isSub方法（pr#39@Gitee）<a id="more"></a></li>
<li>【core】     增加VoidFunc</li>
<li>【extra】     mail适配mail.setting和config/mail.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【corn】     cron适配cron.setting和config/cron.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【poi】       ExcelWriter增加autoSizeColumnAll方法，ExcelBase增加getColumnCount、getRowCount方法（感谢@@【长沙】M）</li>
<li>【http】      添加SoapClient，删除SoapRequest</li>
</ul>
<h3 id="Bug修复"><a href="#Bug修复" class="headerlink" title="Bug修复"></a>Bug修复</h3><ul>
<li>【db】        修复Session中事务问题（issue#IUQMN@Gitee）</li>
<li>【db】        修复Db中关闭逻辑错误导致的事务问题（感谢@【宁波】mojie126）</li>
<li>【http】      修复form方法使用Resource可能导致的空指针问题</li>
<li>【crypto】   修复SM2Engine逻辑错误（感谢bcgit/bc-java）</li>
</ul>
<hr>
<h2 id="4-5-4-1"><a href="#4-5-4-1" class="headerlink" title="4.5.4"></a>4.5.4</h2><h3 id="新特性-1"><a href="#新特性-1" class="headerlink" title="新特性"></a>新特性</h3><ul>
<li>【core】     NetUtil增加getUsableLocalPort方法，并迁移至cn.hutool.core.net包</li>
<li>【core】     FileUtil增加isSub方法（pr#39@Gitee）</li>
<li>【core】     增加VoidFunc</li>
<li>【extra】     mail适配mail.setting和config/mail.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【corn】     cron适配cron.setting和config/cron.setting双配置文件（感谢@【江门】小草哥）</li>
<li>【poi】       ExcelWriter增加autoSizeColumnAll方法，ExcelBase增加getColumnCount、getRowCount方法（感谢@@【长沙】M）</li>
<li>【http】      添加SoapClient，删除SoapRequest</li>
</ul>
<h3 id="Bug修复-1"><a href="#Bug修复-1" class="headerlink" title="Bug修复"></a>Bug修复</h3><ul>
<li>【db】        修复Session中事务问题（issue#IUQMN@Gitee）</li>
<li>【db】        修复Db中关闭逻辑错误导致的事务问题（感谢@【宁波】mojie126）</li>
<li>【http】      修复form方法使用Resource可能导致的空指针问题</li>
<li>【crypto】   修复SM2Engine逻辑错误（感谢bcgit/bc-java）</li>
</ul>
<hr>
<h2 id="4-5-3"><a href="#4-5-3" class="headerlink" title="4.5.3"></a>4.5.3</h2><h3 id="新特性-2"><a href="#新特性-2" class="headerlink" title="新特性"></a>新特性</h3><ul>
<li>【core】       Simhash添加读写锁（issue#IUF9O@Gitee）</li>
<li>【core】       Img增加round方法，圆角给定图片</li>
<li>【extra】      二维码中的图片做圆角处理</li>
<li>【core】       CsvData实现Iterable接口</li>
<li>【extra】      Ftp增加重连方法（pr#38@Gitee）</li>
<li>【extra】      Velocity升级至2.x，不再兼容1.7</li>
</ul>
<h3 id="Bug修复-2"><a href="#Bug修复-2" class="headerlink" title="Bug修复"></a>Bug修复</h3><ul>
<li>【core】       修复ReflectUtil新建Map对象错误问题（issue#IUF9O@Gitee）</li>
<li>【core】       修复ImgUtil字体为null导致的空指针问题（issue#IUF3X@Gitee）</li>
<li>【extra】      修复Ftp中文件上传mkdirs方法创建多余文件夹的问题（issue#ITAYV@Gitee）</li>
<li>【extra】      修复Ftp中文件上传mkdirs方法创建多余文件夹的问题（issue#ITAYV@Gitee）</li>
</ul>
<hr>
]]></content>
      <categories>
        <category>spark</category>
      </categories>
      <tags>
        <tag>hive</tag>
        <tag>hbase</tag>
        <tag>kafka</tag>
      </tags>
  </entry>
</search>
